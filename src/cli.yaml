# -*- yaml -*-
# vim:set ts=2 sw=2 et:

#
# Clap argument parser do not support YAML refrences.
# Or maybe rust-yaml package?
#
# E.g. that do not work:
# ```
# item: &item
#   sub: true
#
# item2:
#   <<: *item
# ```
#

name: ota-tool
about: Firmware image packer for OTA
author: Vladimir Ermakov <vooon341@gmail.com>
args:
  - debug:
      short: d
      long: debug
      help: Enable debugging messages

subcommands:
  - mkfw:
      name: ota-mkfw  # seems clap-rs don't use arg[0] for subcommand selection :(
      about: "Create image file"
      args:
        - OUTPUT:
            short: o
            long: output
            value_name: FILE
            help: Output file
            takes_value: true
            required: true

        - desc:
            long: desc
            help: Description
            takes_value: true
        - board:
            short: b
            long: board
            help: Board ID
            takes_value: true
            required: true
        - version:
            short: v
            long: out-version
            help: Project version
            takes_value: true
            conflicts_with: [git_identity]
            required: true
        - rev:
            short: r
            long: rev
            help: SCM revision
            takes_value: true
            conflicts_with: [git_identity]
            required: true
        - git_identity:
            long: git-identity
            help: Extract revision and tag from GIT SCM
        - build_date:
            short: D
            long: build-date
            help: "Build date RFC3339 or ISO8601 (default: now)"
            takes_value: true

        # image file args:
        - name:
            short: n
            long: name
            help: Image name (e.g. firmware.bin)
            takes_value: true
            multiple: true
        - load_addr:
            short: a
            long: load-addr
            help: Load address
            takes_value: true
            multiple: true
        - dfu_alt:
            long: dfu-alt
            value_name: N
            help: DFU Alternate setting
            takes_value: true
            multiple: true
        - INPUT:
            value_name: FILE
            help: Input file(s)
            required: true
            multiple: true

      arg_groups:
        - input-file:
            args:
              - name
              - load_addr
              - dfu_alt
              - INPUT
        - version-info:
            args:
              - version
              - revision
              - git_identity
            required: true

  - upload:
      name: ota-upload
      about: "Upload firmware image to OTA server"
      args:
        - url:
            short: u
            long: url
            help: Upload form URL
            #default: http://localhost:8081/
            takes_value: true
        - repo:
            short: p
            long: repo
            help: Repository name
            takes_value: true
            required: true
        - key:
            short: k
            long: key
            help: Repository access key
            takes_value: true
            required: true
        - rev:
            short: r
            long: rev
            help: SCM revision
            takes_value: true
            conflicts_with: [git_identity]
        - tag:
            short: t
            long: tag
            help: SCM tag (release)
            takes_value: true
            conflicts_with: [git_identity]
        - git_identity:
            long: git-identity
            help: Extract revision and tag from GIT SCM
        - build_date:
            short: D
            long: build-date
            help: "Build date RFC3339 or ISO8601 (default: now)"
            takes_value: true
        - file_type:
            long: file-type
            help: File type (for index)
            takes_value: true
        - FILE:
            required: true
            help: File to upload.
